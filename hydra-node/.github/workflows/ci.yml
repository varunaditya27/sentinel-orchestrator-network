name: Hydra Settlement Layer CI

on:
  push:
    branches: [ main, develop, release/** ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run unit tests
      run: |
        python test_hydra_control.py

    - name: Run smoke acceptance test
      run: |
        python hydra_control.py --open --session-id smoke-test
        python hydra_control.py --commit --session-id smoke-test --payload test_vectors/v1_safe.json --skip-sig-check
        python hydra_control.py --attach-proof --session-id smoke-test --order-id o-smoke-test-0001 --proof-ref smoke-proof
        python hydra_control.py --finalize --session-id smoke-test

    - name: Verify state persistence
      run: |
        if [ ! -f state/heads.json ]; then echo "heads.json not created"; exit 1; fi
        if [ ! -f state/orders.json ]; then echo "orders.json not created"; exit 1; fi
        echo "State files created successfully"

    - name: Build Docker image
      run: |
        docker build -f Dockerfile.hydra_control -t hydra-control-test .
        docker run --rm hydra-control-test python -c "from hydra_control import HydraControlClient; print('Import test passed')"

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check for private keys in committed files
      run: |
        if git grep -l "private_key" -- "*.json" | grep -v demo_keys_local.json; then
          echo "ERROR: Private keys found in committed files!"
          exit 1
        fi
        echo "No private keys in committed files"
